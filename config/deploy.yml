service: solohost
image: mktcode/solohost
servers:
  web:
    - <%= `echo $APP1_IP` %>
registry:
  username: mktcode
  password:
    - KAMAL_REGISTRY_PASSWORD
ssh:
  keys_only: true
  keys: ["~/.ssh/hetzner"]
env:
  secret:
    - MYSQL_ROOT_PASSWORD
    - NUXT_DATABASE_URL
    - NUXT_PUBLIC_APP_HOST
    - NUXT_PUBLIC_LB_IP
    - NUXT_SESSION_PASSWORD
    - NUXT_MAIL_HOST
    - NUXT_MAIL_USER
    - NUXT_MAIL_PASS
    - NUXT_MAIL_FROM
    - NUXT_OPENAI_API_KEY
    - NUXT_S3_ACCESS_KEY
    - NUXT_S3_SECRET_KEY
    - NUXT_S3_BUCKET_NAME
    - NUXT_PUBLIC_S3_ENDPOINT
    - NUXT_PUBLIC_STRIPE_API_KEY
    - NUXT_STRIPE_API_SECRET_KEY
    - NUXT_STRIPE_WEBHOOK_SECRET
    - NUXT_STRIPE_PRICE_S_ID
    - NUXT_STRIPE_PRICE_L_ID
    - NUXT_PUBLIC_STRIPE_PORTAL_URL
    - NUXT_CHATWOOT_INBOX_ID
    - NUXT_CHATWOOT_HMAC_SECRET
    - NUXT_CHATWOOT_API_KEY
aliases:
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  migrate: app exec --primary 'npx tsx server/migrate.ts'
  migrate-down: app exec --primary 'npx tsx server/down.ts'
  db: accessory exec db --interactive --reuse "bash"
builder:
  arch:
    # - amd64
    - arm64
proxy:
  forward_headers: true
  response_timeout: 600
  buffering:
    responses: false
accessories:
  db:
    image: mysql:9.0
    host: <%= `echo $DB_IP` %>
    port: 3306
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
      secret:
        - MYSQL_ROOT_PASSWORD
    files:
      - server/db/init.sql:/docker-entrypoint-initdb.d/setup.sql
    directories:
      - data:/var/lib/mysql